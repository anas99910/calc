<!DOCTYPE html>
<html lang="en" class="dark"> <!-- Start in dark mode -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speedyex Filtre</title>

    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 3. Firebase SDK (ES Modules) -->
    <!-- Firebase has been removed. Using localStorage. -->

    <!-- Configuration for Tailwind dark mode and theme -->
    <script>
        tailwind.config = {
            darkMode: 'class', // Enable class-based dark mode
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        // Add custom font for logo
                        logo: ['Pacifico', 'cursive'], 
                    },
                    colors: {
                        'gray-950': '#0A0A0A',
                        'gray-900': '#121212',
                        'gray-800': '#1E1E1E',
                        'gray-700': '#2C2C2C',
                        'gray-600': '#3A3A3A',
                    },
                    borderRadius: {
                        'xl': '0.75rem',
                        '2xl': '1.0rem',
                        '3xl': '1.5rem',
                    },
                    boxShadow: {
                        // Updated shadow for light mode
                        'hard': '0 0 0 1px rgba(0, 0, 0, 0.05), 0 4px 12px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>

    <!-- Custom Styles -->
    <style type="text/css">
        /* Import Google Font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Pacifico&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Main calendar grid layout */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 1px; /* Creates the thin border effect */
        }

        /* Calendar cell styling */
        .calendar-day-cell {
            position: relative;
            min-height: 120px; /* Taller cells for event space */
            transition: background-color 0.2s;
        }
        
        /* Today's date highlight */
        .calendar-day-cell.today .day-number {
            background-color: #3B82F6; /* Blue-600 */
            color: white;
            border-radius: 9999px;
            width: 28px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
        }
        
        /* Faded numbers for non-current month days */
        .calendar-day-cell.other-month {
            opacity: 0.7; /* Reverted to dark-mode style */
        }

        /* Modal transitions */
        .modal-backdrop {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 40;
            /* Dark theme backdrop */
            background-color: rgba(17, 24, 39, 0.8); /* gray-900 opacity 80 */
        }
        .modal-backdrop.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            transform: translateY(20px) scale(0.98);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 50;
        }
        .modal-backdrop.visible .modal-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        /* Custom scrollbar for modal content (dark theme) */
        .modal-scroll-content::-webkit-scrollbar {
            width: 8px;
        }
        .modal-scroll-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05); /* dark */
            border-radius: 10px;
        }
        .modal-scroll-content::-webkit-scrollbar-thumb {
            background: #4B5563; /* gray-600 */
            border-radius: 10px;
        }
        .modal-scroll-content::-webkit-scrollbar-thumb:hover {
            background: #6B7280; /* gray-500 */
        }
        
        /* Toast notification (Kept dark for contrast) */
        #toast-notification {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            transition: bottom 0.5s ease-in-out;
            z-index: 100;
            background-color: #374151; /* gray-700 */
            color: white;
        }
        #toast-notification.show {
            bottom: 30px;
        }

        /* Simple loading spinner (dark theme) */
        .spinner {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: inline-block;
            /* White top border */
            border-top: 4px solid #FFF; 
            border-right: 4px solid transparent;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Styling for event pill icons */
        .event-pill .status-icon {
            width: 0.75rem; /* 12px */
            height: 0.75rem;
            display: inline-block;
            margin-right: 4px;
        }
        
        /* Responsive calendar for mobile */
        @media (max-width: 768px) {
            .calendar-day-cell {
                min-height: 80px; /* Shorter cells on mobile */
                padding: 4px;
            }
            .day-number {
                font-size: 0.8rem;
            }
            .event-pill {
                font-size: 0.7rem;
                padding: 2px 4px;
                margin-top: 2px;
            }
            .calendar-weekdays {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<!-- Dark theme body -->
<body class="bg-gray-950 text-gray-200">

    <!-- Loading Overlay (dark theme) -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-950 bg-opacity-80 flex flex-col items-center justify-center z-[999]">
        <div class="spinner"></div>
        <p class="text-lg text-gray-300 mt-4">Loading Speedyex Filtre...</p>
        <p class="text-sm text-gray-500 mt-1">Initializing local storage...</p>
    </div>

    <!-- App Wrapper -->
    <div id="app-wrapper" class="flex flex-col h-screen max-w-7xl mx-auto p-4 md:p-8">

        <!-- Header -->
        <header class="flex flex-col md:flex-row md:items-center md:justify-between pb-4 bg-gray-900 dark:bg-gray-900 shadow-md rounded-xl"> <!-- Dark mode header -->
            <!-- New header content based on image -->
            <div class="flex items-center gap-3 px-6 py-2">
                <!-- Water Drop SVG Icon -->
                <svg class="w-10 h-10 text-blue-500" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2.24615C12 2.24615 18 8.68269 18 13.9385C18 19.1942 15.3137 22.2308 12 22.2308C8.68629 22.2308 6 19.1942 6 13.9385C6 8.68269 12 2.24615 12 2.24615Z" />
                </svg>
                <!-- Title with custom font -->
                <h1 class="text-3xl font-logo text-blue-600">Speedyex Filtre</h1>
            </div>
            
            <div class="flex items-center gap-2 mt-4 md:mt-0 px-6">
                <!-- Search Input (dark theme) -->
                <div class="relative">
                    <input type="text" id="search-input" placeholder="Search clients or events..." class="w-full md:w-64 bg-gray-800 border border-gray-700 rounded-lg py-2 px-4 pl-10 text-sm text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500"></i>
                </div>
                
                <!-- Buttons (dark theme) -->
                <button id="btn-view-reminders" title="View Reminders" class="p-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-300 hover:text-white hover:bg-gray-700 transition-colors">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                </button>
                <button id="btn-view-inventory" title="Manage Inventory" class="p-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-300 hover:text-white hover:bg-gray-700 transition-colors">
                    <i data-lucide="package" class="w-5 h-5"></i>
                </button>
                <button id="btn-view-clients" title="View All Clients" class="p-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-300 hover:text-white hover:bg-gray-700 transition-colors">
                    <i data-lucide="users" class="w-5 h-5"></i>
                </button>
                <button id="btn-new-client" title="New Client" class="p-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-300 hover:text-white hover:bg-gray-700 transition-colors">
                    <i data-lucide="user-plus" class="w-5 h-5"></i>
                </button>
                <!-- Dark mode toggle -->
                <button id="btn-toggle-dark-mode" title="Toggle theme" class="p-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-300 hover:text-white hover:bg-gray-700 transition-colors">
                    <i data-lucide="moon" class="w-5 h-5 hidden dark:block"></i>
                    <i data-lucide="sun" class="w-5 h-5 block dark:hidden"></i>
                </button>
                <button id="btn-new-event" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                    <span>New Event</span>
                </button>
            </div>
        </header>

        <!-- Main Content: Calendar -->
        <main class="flex-1 mt-6 flex flex-col">
            <!-- Calendar Controls (dark theme) -->
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
                <!-- Month Navigation -->
                <div class="flex items-center gap-4">
                    <button id="btn-prev-month" class="p-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-300 hover:text-white hover:bg-gray-700 transition-colors">
                        <i data-lucide="chevron-left" class="w-5 h-5"></i>
                    </button>
                    <h2 id="month-year-header" class="text-2xl font-semibold text-white w-48 text-center">...</h2>
                    <button id="btn-next-month" class="p-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-300 hover:text-white hover:bg-gray-700 transition-colors">
                        <i data-lucide="chevron-right" class="w-5 h-5"></i>
                    </button>
                    <button id="btn-today" class="bg-gray-800 border border-gray-700 rounded-lg text-gray-300 hover:text-white hover:bg-gray-700 transition-colors text-sm px-3 py-2">
                        Today
                    </button>
                </div>
                
                <!-- Legend -->
                <div class="flex flex-wrap gap-2 md:gap-4 mt-4 md:mt-0 text-xs text-gray-400">
                    <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-blue-500"></span>Installation</div>
                    <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-green-500"></span>Maintenance</div>
                    <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-yellow-500"></span>Filter Change</div>
                    <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-purple-500"></span>General</div>
                    <div class="flex items-center gap-1.5"><i data-lucide="dollar-sign" class="w-3 h-3 text-green-500"></i>Paid</div>
                    <div class="flex items-center gap-1.5"><i data-lucide="check-circle" class="w-3 h-3 text-green-500"></i>Completed</div>
                </div>
            </div>

            <!-- Calendar Grid (dark theme) -->
            <div class="flex-1 flex flex-col bg-gray-700 rounded-2xl shadow-hard overflow-hidden">
                <!-- Weekday Headers -->
                <div class="calendar-weekdays grid grid-cols-7 bg-gray-800 border-b border-gray-700">
                    <div class="text-center text-sm font-medium text-gray-400 p-3">Sun</div>
                    <div class="text-center text-sm font-medium text-gray-400 p-3">Mon</div>
                    <div class="text-center text-sm font-medium text-gray-400 p-3">Tue</div> <!-- Corrected from gray-500 -->
                    <div class="text-center text-sm font-medium text-gray-400 p-3">Wed</div> <!-- Corrected from gray-500 -->
                    <div class="text-center text-sm font-medium text-gray-400 p-3">Thu</div> <!-- Corrected from gray-500 -->
                    <div class="text-center text-sm font-medium text-gray-400 p-3">Fri</div> <!-- Corrected from gray-500 -->
                    <div class="text-center text-sm font-medium text-gray-400 p-3">Sat</div> <!-- Corrected from gray-500 -->
                </div>
                
                <!-- Day Cells -->
                <div id="calendar-grid" class="calendar-grid flex-1">
                    <!-- Calendar cells will be dynamically generated here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->

    <!-- Event Modal (Add/Edit) (dark theme) -->
    <div id="event-modal" class="modal-backdrop fixed inset-0 backdrop-blur-md flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-2xl bg-gray-800 rounded-2xl shadow-2xl border border-gray-700 flex flex-col max-h-[90vh]">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-5 border-b border-gray-700">
                <h3 id="event-modal-title" class="text-xl font-semibold text-white">New Appointment</h3>
                <button class="btn-close-modal p-1 text-gray-400 hover:text-white rounded-full hover:bg-gray-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <!-- Modal Body -->
            <form id="event-form" class="flex-1 overflow-y-auto modal-scroll-content p-6 space-y-5">
                <input type="hidden" id="event-id">
                <input type="hidden" id="event-old-status">
                <input type="hidden" id="event-old-filter-used">

                <!-- Job Status & Billing -->
                <div class="p-4 bg-gray-900/50 border border-gray-700 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="event-status" class="text-sm font-medium text-gray-300 mb-2 block">Job Status</label>
                            <select id="event-status" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2.5 px-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                <option value="Scheduled">Scheduled</option>
                                <option value="Completed">Completed</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div id="billing-section">
                            <label for="event-payment-status" class="text-sm font-medium text-gray-300 mb-2 block">Billing Status</label>
                            <select id="event-payment-status" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2.5 px-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                <option value="Not Invoiced">Not Invoiced</option>
                                <option value="Invoiced">Invoiced</option>
                                <option value="Paid">Paid</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Event Type -->
                <div>
                    <label class="text-sm font-medium text-gray-300 mb-2 block">Event Type</label>
                    <select id="event-type" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2.5 px-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <option value="Installation">Installation</option>
                        <option value="Maintenance">Maintenance</option>
                        <option value="Filter Change">Filter Change</option>
                        <option value="General">General Reminder</option>
                    </select>
                </div>
                
                <!-- Client Selection -->
                <div id="client-section" class="space-y-4">
                    <label class="text-sm font-medium text-gray-300 block">Client</label>
                    <div class="flex gap-2">
                        <select id="event-client-id" class="flex-1 bg-gray-700 border border-gray-600 rounded-lg py-2.5 px-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option value="">Select an existing client</option>
                            <!-- Client options added dynamically -->
                        </select>
                        <button type="button" id="btn-create-new-client-inline" title="Create New Client" class="p-2.5 bg-gray-700 border border-gray-600 rounded-lg text-gray-300 hover:text-white hover:bg-gray-600 transition-colors">
                            <i data-lucide="user-plus" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Title (for General Reminder) -->
                <div id="title-section">
                    <label for="event-title" class="text-sm font-medium text-gray-300 mb-2 block">Title</label>
                    <input type="text" id="event-title" placeholder="e.g., 'Team Meeting'" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2.5 px-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                </div>

                <!-- Date & Time -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="event-date" class="text-sm font-medium text-gray-300 mb-2 block">Date</label>
                        <input type="date" id="event-date" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2.5 px-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none">
                    </div>
                    <div>
                        <label for="event-time" class="text-sm font-medium text-gray-300 mb-2 block">Time</label>
                        <input type="time" id="event-time" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2.5 px-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none">
                    </div>
                </div>
                
                <!-- Filter Used (for auto-inventory) -->
                <div id="filter-used-section" class="hidden">
                    <label for="event-filter-used" class="text-sm font-medium text-gray-300 mb-2 block">Filter Used (for Inventory)</label>
                    <select id="event-filter-used" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2.5 px-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <option value="">None</option>
                        <!-- Filter options added dynamically from inventory -->
                    </select>
                </div>

                <!-- Technician & Cost -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="event-technician" class="text-sm font-medium text-gray-300 mb-2 block">Assigned Technician</label>
                        <input type="text" id="event-technician" placeholder="e.g., John D." class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2.5 px-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>
                    <div>
                        <label for="event-cost" class="text-sm font-medium text-gray-300 mb-2 block">Cost (e.g., 150.00)</label>
                        <input type="number" id="event-cost" step="0.01" placeholder="150.00" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2.5 px-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>
                </div>
                
                <!-- Smart Reminder for Installations -->
                <div id="smart-reminder-section" class="p-4 bg-gray-900/50 border border-gray-700 rounded-lg space-y-3 hidden">
                    <p class="text-sm font-medium text-white">Smart Reminder</p>
                    <p class="text-xs text-gray-400">This is an installation. Do you want to automatically schedule a filter change reminder based on the client's default filter lifespan?</p>
                    <div class="flex items-center gap-4">
                        <label for="filter-lifespan" class="text-sm text-gray-300">Lifespan (days):</label>
                        <input type="number" id="filter-lifespan" value="180" class="w-24 bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>
                    <div class="flex items-center">
                        <input id="create-smart-reminder" type="checkbox" checked class="h-4 w-4 rounded border-gray-600 bg-gray-700 text-blue-600 focus:ring-blue-500">
                        <label for="create-smart-reminder" class="ml-2 block text-sm text-gray-300">Yes, create a "Filter Change" reminder</label>
                    </div>
                </div>

                <!-- Notes -->
                <div>
                    <label for="event-notes" class="text-sm font-medium text-gray-300 mb-2 block">Notes</label>
                    <textarea id="event-notes" rows="3" placeholder="Add any relevant details..." class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2.5 px-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none"></textarea>
                </div>
            </form>
            
            <!-- Modal Footer -->
            <div class="flex items-center justify-between p-5 bg-gray-800 border-t border-gray-700 rounded-b-2xl">
                <button type="button" id="btn-delete-event" class="text-red-500 hover:text-red-400 font-medium px-4 py-2.5 rounded-lg hover:bg-red-900/30 transition-colors text-sm">
                    Delete Event
                </button>
                <div class="flex gap-3">
                    <button type="button" class="btn-close-modal bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2.5 px-6 rounded-xl transition-colors">
                        Cancel
                    </button>
                    <button type="submit" form="event-form" class="bg-blue-600 hover:bg-blue-500 text-white font-semibold py-2.5 px-6 rounded-xl transition-colors">
                        Save Event
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Client Modal (Add/Edit) (dark theme) -->
    <div id="client-modal" class="modal-backdrop fixed inset-0 backdrop-blur-md flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-3xl bg-gray-800 rounded-2xl shadow-2xl border border-gray-700 flex flex-col max-h-[90vh]">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-5 border-b border-gray-700">
                <h3 id="client-modal-title" class="text-xl font-semibold text-white">New Client</h3>
                <button class="btn-close-modal p-1 text-gray-400 hover:text-white rounded-full hover:bg-gray-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
                <!-- Client Form -->
                <form id="client-form" class="w-full md:w-1/2 p-6 space-y-4 border-b md:border-b-0 md:border-r border-gray-700 overflow-y-auto modal-scroll-content">
                    <input type="hidden" id="client-id">
                    <div>
                        <label for="client-name" class="text-sm font-medium text-gray-300 mb-2 block">Full Name</label>
                        <input type="text" id="client-name" placeholder="e.g., Jane Doe" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2.5 px-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
                    </div>
                    <div>
                        <label for="client-phone" class="text-sm font-medium text-gray-300 mb-2 block">Phone Number</label>
                        <input type="tel" id="client-phone" placeholder="e.g., (555) 123-4567" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2.5 px-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>
                    <div>
                        <label for="client-address" class="text-sm font-medium text-gray-300 mb-2 block">Primary Address</label>
                        <textarea id="client-address" rows="2" placeholder="e.g., 123 Main St, Anytown, USA" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2.5 px-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="client-filter-type" class="text-sm font-medium text-gray-300 mb-2 block">Default Filter Type</label>
                            <select id="client-filter-type" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2.5 px-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                <option value="">None</option>
                                <!-- Filter options added dynamically -->
                            </select>
                        </div>
                        <div>
                            <label for="client-filter-lifespan" class="text-sm font-medium text-gray-300 mb-2 block">Lifespan (Days)</label>
                            <input type="number" id="client-filter-lifespan" value="180" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2.5 px-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>
                    </div>
                    
                    <div>
                        <label for="client-notes" class="text-sm font-medium text-gray-300 mb-2 block">Permanent Notes</label>
                        <textarea id="client-notes" rows="3" placeholder="e.g., Prefers morning appointments" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2.5 px-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none"></textarea>
                    </div>
                </form>
                
                <!-- Client History -->
                <div id="client-history-section" class="w-full md:w-1/2 p-6 flex flex-col overflow-y-auto modal-scroll-content">
                    <h4 class="text-lg font-semibold text-white mb-4">Maintenance History</h4>
                    <div id="client-history-list" class="flex-1 space-y-3">
                        <!-- History items generated here -->
                        <p class="text-sm text-gray-400">No history found for this client.</p>
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="flex items-center justify-between p-5 bg-gray-800 border-t border-gray-700 rounded-b-2xl">
                <button type="button" id="btn-delete-client" class="text-red-500 hover:text-red-400 font-medium px-4 py-2.5 rounded-lg hover:bg-red-900/30 transition-colors text-sm">
                    Delete Client
                </button>
                <div class="flex gap-3">
                    <button type="button" class="btn-close-modal bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2.5 px-6 rounded-xl transition-colors">
                        Cancel
                    </button>
                    <button type="submit" form="client-form" class="bg-blue-600 hover:bg-blue-500 text-white font-semibold py-2.5 px-6 rounded-xl transition-colors">
                        Save Client
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Reminders List Modal (dark theme) -->
    <div id="reminders-modal" class="modal-backdrop fixed inset-0 backdrop-blur-md flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-2xl bg-gray-800 rounded-2xl shadow-2xl border border-gray-700 flex flex-col max-h-[70vh]">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-5 border-b border-gray-700">
                <h3 class="text-xl font-semibold text-white">Upcoming Events & Reminders</h3>
                <button class="btn-close-modal p-1 text-gray-400 hover:text-white rounded-full hover:bg-gray-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <!-- Modal Body -->
            <div id="reminders-list" class="flex-1 overflow-y-auto modal-scroll-content p-6 space-y-4">
                <!-- Reminder items will be generated here -->
                <p class="text-sm text-gray-400">No upcoming events found.</p>
            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-end p-5 bg-gray-800 border-t border-gray-700 rounded-b-2xl">
                <button type="button" class="btn-close-modal bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2.5 px-6 rounded-xl transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Inventory Modal (dark theme) -->
    <div id="inventory-modal" class="modal-backdrop fixed inset-0 backdrop-blur-md flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-xl bg-gray-800 rounded-2xl shadow-2xl border border-gray-700 flex flex-col max-h-[70vh]">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-5 border-b border-gray-700">
                <h3 class="text-xl font-semibold text-white">Filter Inventory</h3>
                <button class="btn-close-modal p-1 text-gray-400 hover:text-white rounded-full hover:bg-gray-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <!-- Add New Filter Form -->
            <form id="new-filter-form" class="p-5 border-b border-gray-700 flex items-end gap-3">
                <div class="flex-1">
                    <label for="new-filter-name" class="text-sm font-medium text-gray-300 mb-2 block">New Filter Type</label>
                    <input type="text" id="new-filter-name" placeholder="e.g., RO-5" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2.5 px-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
                </div>
                <div class="w-28">
                    <label for="new-filter-quantity" class="text-sm font-medium text-gray-300 mb-2 block">In Stock</label>
                    <input type="number" id="new-filter-quantity" value="0" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2.5 px-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
                </div>
                <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white font-semibold py-2.5 px-4 rounded-lg transition-colors">Add</button>
            </form>

            <!-- Inventory List -->
            <div id="inventory-list" class="flex-1 overflow-y-auto modal-scroll-content p-6 space-y-3">
                <!-- Inventory items will be generated here -->
                <p class="text-sm text-gray-400">No inventory items found.</p>
            </div>
        </div>
    </div>

    <!-- Client List Modal (dark theme) -->
    <div id="client-list-modal" class="modal-backdrop fixed inset-0 backdrop-blur-md flex items-center justify-center p-4">
        <div class="modal-content w-full max-w-2xl bg-gray-800 rounded-2xl shadow-2xl border border-gray-700 flex flex-col max-h-[70vh]">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-5 border-b border-gray-700">
                <h3 class="text-xl font-semibold text-white">All Clients</h3>
                <button class="btn-close-modal p-1 text-gray-400 hover:text-white rounded-full hover:bg-gray-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <!-- Search / Add -->
            <div class="p-5 border-b border-gray-700 flex items-center gap-3">
                <div class="relative flex-1">
                    <input type="text" id="client-list-search" placeholder="Search clients..." class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2.5 px-3 pl-10 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                     <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                </div>
                <button id="btn-new-client-from-list" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white font-semibold py-2.5 px-4 rounded-lg transition-colors">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                    <span>New Client</span>
                </button>
            </div>

            <!-- Client List -->
            <div id="client-list-container" class="flex-1 overflow-y-auto modal-scroll-content p-6 space-y-3">
                <!-- Client items will be generated here -->
                <p class="text-sm text-gray-400">No clients found.</p>
            </div>
        </div>
    </div>

    <!-- Toast Notification (for Undo) -->
    <div id="toast-notification" class="bg-gray-700 text-white py-3 px-5 rounded-lg shadow-lg flex items-center gap-4">
        <span id="toast-message">Event deleted.</span>
        <button id="toast-undo-btn" class="font-bold text-blue-400 hover:text-blue-300">Undo</button>
    </div>

    <!-- Main Application Script -->
    <script type="module">
        // --- App State ---
        let appId;
        let currentDate = new Date();
        let events = [];
        let clients = [];
        let inventory = [];
        let selectedEventId = null;
        let selectedClientId = null;
        let searchFilter = '';
        let toastTimer = null;
        
        // localStorage keys
        const EVENTS_KEY = 'speedyex-events';
        const CLIENTS_KEY = 'speedyex-clients';
        const INVENTORY_KEY = 'speedyex-inventory';

        // --- App Initialization ---
        try {
            // Get appId from global scope or set a default
            appId = typeof __app_id !== 'undefined' ? __app_id : 'speedyex-filtre-app-local';
            console.log("App Initializing locally for appId:", appId);
            
            // Immediately initialize the app
            initApp();

        } catch (error) {
            console.error("Failed to initialize app:", error);
            showLoadingError("Failed to initialize application. Check console for details.");
        }

        /**
         * Shows an error message on the loading screen.
         */
        function showLoadingError(message) {
            const overlay = document.getElementById('loading-overlay');
            overlay.innerHTML = `
                <i data-lucide="alert-triangle" class="w-16 h-16 text-red-500"></i>
                <p class="text-lg text-red-400 mt-4">Error</p>
                <p class="text-sm text-gray-400 mt-1">${message}</p>
            `;
            lucide.createIcons();
        }

        /**
         * Main application initialization function.
         */
        function initApp() {
            console.log(`Initializing app locally for appId ${appId}`);
            
            // Setup all UI event listeners
            setupEventListeners();
            
            // Load data from local storage
            loadDataFromLocalStorage();
            
            // Add sample data if local storage is empty
            addSampleDataIfNeeded();
            
            // Hide loading overlay
            document.getElementById('loading-overlay').style.display = 'none';
            
            // Render icons
            lucide.createIcons();
        }

        // --- localStorage Data Functions ---

        /**
         * Loads all data from localStorage and triggers a full UI render.
         */
        function loadDataFromLocalStorage() {
            events = JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]');
            clients = JSON.parse(localStorage.getItem(CLIENTS_KEY) || '[]');
            inventory = JSON.parse(localStorage.getItem(INVENTORY_KEY) || '[]');
            
            clients.sort((a, b) => a.name.localeCompare(b.name));
            inventory.sort((a, b) => a.name.localeCompare(b.name));

            console.log(`Loaded ${events.length} events, ${clients.length} clients, ${inventory.length} inventory items.`);

            // Trigger all UI updates
            renderCalendar();
            populateRemindersModal();
            populateClientDropdowns();
            renderClientList();
            renderInventoryList();
            populateInventoryDropdowns();
        }

        /**
         * Saves the events array to localStorage and re-renders.
         */
        function saveEvents() {
            localStorage.setItem(EVENTS_KEY, JSON.stringify(events));
            // After saving, re-render what's necessary
            renderCalendar();
            populateRemindersModal();
        }
        
        /**
         * Saves the clients array to localStorage and re-renders.
         */
        function saveClients() {
            localStorage.setItem(CLIENTS_KEY, JSON.stringify(clients));
            // Re-sort and re-render
            clients.sort((a, b) => a.name.localeCompare(b.name));
            populateClientDropdowns();
            renderClientList();
        }

        /**
         * Saves the inventory array to localStorage and re-renders.
         */
        function saveInventory() {
            localStorage.setItem(INVENTORY_KEY, JSON.stringify(inventory));
            // Re-sort and re-render
            inventory.sort((a, b) => a.name.localeCompare(b.name));
            renderInventoryList();
            populateInventoryDropdowns();
        }

        /**
         * Adds sample data if localStorage is empty.
         */
        function addSampleDataIfNeeded() {
            // Check if data already exists
            if (events.length > 0 || clients.length > 0 || inventory.length > 0) {
                console.log("Data already exists.");
                return;
            }

            console.log("No data found. Adding sample data...");

            // 1. Add sample inventory
            const sampleInv = { 
                id: crypto.randomUUID(), // Generate ID
                name: "RO-5", 
                quantity: 50 
            };
            inventory.push(sampleInv);
            
            // 2. Add sample client
            const sampleClient = {
                id: crypto.randomUUID(), // Generate ID
                name: "John Sample",
                phone: "555-0101",
                address: "123 Sample St, Testville",
                defaultFilterType: sampleInv.name,
                filterLifespanDays: 180,
                notes: "First sample client.",
                createdAt: new Date().toISOString() // Use ISO string
            };
            clients.push(sampleClient);
            
            // 3. Add sample events
            const today = new Date();
            const eventData1 = {
                id: crypto.randomUUID(), // Generate ID
                clientId: sampleClient.id,
                clientName: sampleClient.name,
                date: today.toISOString().split('T')[0],
                time: "10:00",
                type: "Installation",
                technician: "Mike",
                cost: 250,
                notes: "Initial installation.",
                status: "Scheduled",
                paymentStatus: "Not Invoiced",
                filterUsed: null,
                createdAt: new Date().toISOString()
            };
            events.push(eventData1);
            
            const nextWeek = new Date(today.setDate(today.getDate() + 7));
            const eventData2 = {
                id: crypto.randomUUID(), // Generate ID
                title: "Team Debrief",
                clientId: null,
                clientName: null,
                date: nextWeek.toISOString().split('T')[0],
                time: "09:00",
                type: "General",
                technician: "All",
                cost: 0,
                notes: "Discuss Q3 goals.",
                status: "Scheduled",
                paymentStatus: "Not Invoiced",
                filterUsed: null,
                createdAt: new Date().toISOString()
            };
            events.push(eventData2);

            // 4. Save all new data to localStorage
            localStorage.setItem(EVENTS_KEY, JSON.stringify(events));
            localStorage.setItem(CLIENTS_KEY, JSON.stringify(clients));
            localStorage.setItem(INVENTORY_KEY, JSON.stringify(inventory));
            
            // 5. Manually call loadData again to trigger all renders
            loadDataFromLocalStorage();
        }


        /**
         * Sets up all global event listeners for buttons, forms, etc.
         */
        function setupEventListeners() {
            // Calendar navigation
            document.getElementById('btn-prev-month').addEventListener('click', () => changeMonth(-1));
            document.getElementById('btn-next-month').addEventListener('click', () => changeMonth(1));
            document.getElementById('btn-today').addEventListener('click', () => {
                currentDate = new Date();
                renderCalendar();
            });

            // Header actions
            document.getElementById('btn-new-event').addEventListener('click', () => openEventModal(null, new Date()));
            document.getElementById('btn-new-client').addEventListener('click', () => openClientModal(null));
            document.getElementById('btn-view-reminders').addEventListener('click', openRemindersModal);
            document.getElementById('btn-view-inventory').addEventListener('click', openInventoryModal);
            document.getElementById('btn-view-clients').addEventListener('click', openClientListModal);
            document.getElementById('btn-toggle-dark-mode').addEventListener('click', toggleDarkMode);

            // Search
            document.getElementById('search-input').addEventListener('input', (e) => {
                searchFilter = e.target.value.toLowerCase();
                renderCalendar(); // Re-render to apply filter
            });

            // Modal close buttons
            document.querySelectorAll('.btn-close-modal').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modal = e.target.closest('.modal-backdrop');
                    closeModal(modal);
                });
            });

            // Event Modal
            document.getElementById('event-form').addEventListener('submit', handleEventFormSubmit);
            document.getElementById('btn-delete-event').addEventListener('click', deleteSelectedEvent);
            document.getElementById('event-type').addEventListener('change', toggleEventFormFields);
            document.getElementById('event-status').addEventListener('change', toggleEventFormFields); // Trigger on status change too
            document.getElementById('event-client-id').addEventListener('change', (e) => {
                // Pre-fill tech and lifespan from selected client
                const clientId = e.target.value;
                const client = clients.find(c => c.id === clientId);
                if (client) {
                    const techInput = document.getElementById('event-technician');
                    if (!techInput.value && client.assignedTechnician) {
                        techInput.value = client.assignedTechnician;
                    }
                    document.getElementById('filter-lifespan').value = client.filterLifespanDays || 180;
                    
                    // Pre-fill filter used from client's default
                    if (client.defaultFilterType) {
                        document.getElementById('event-filter-used').value = client.defaultFilterType;
                    }
                }
            });
            
            // Client Modal
            document.getElementById('client-form').addEventListener('submit', handleClientFormSubmit);
            document.getElementById('btn-delete-client').addEventListener('click', deleteSelectedClient);
            document.getElementById('btn-create-new-client-inline').addEventListener('click', () => {
                closeModal(document.getElementById('event-modal'));
                openClientModal(null, true); // `true` indicates it was opened from event modal
            });
            
            // Client List Modal
            document.getElementById('client-list-search').addEventListener('input', renderClientList);
            document.getElementById('btn-new-client-from-list').addEventListener('click', () => {
                closeModal(document.getElementById('client-list-modal'));
                openClientModal(null); // Open new client modal
            });

            // Inventory Modal
            document.getElementById('new-filter-form').addEventListener('submit', handleNewFilterForm);
        }

        // --- Calendar Logic ---

        /**
         * Renders the main calendar grid for the `currentDate`.
         */
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = ''; // Clear existing grid

            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            
            // Update header
            document.getElementById('month-year-header').textContent = 
                `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;

            // Get calendar days
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const prevMonthDays = new Date(year, month, 0).getDate();

            const todayStr = new Date().toISOString().split('T')[0];

            // 42 cells for 6 weeks
            for (let i = 0; i < 42; i++) {
                const cell = document.createElement('div');
                // Dark theme cell
                cell.className = 'calendar-day-cell bg-gray-900 border-t border-l border-gray-700 p-2 overflow-hidden';
                
                let dayNum, dateObj, dateStr;

                if (i < firstDayOfMonth) {
                    // Previous month
                    dayNum = prevMonthDays - firstDayOfMonth + 1 + i;
                    dateObj = new Date(year, month - 1, dayNum);
                    cell.classList.add('other-month');
                } else if (i >= firstDayOfMonth && i < firstDayOfMonth + daysInMonth) {
                    // Current month
                    dayNum = i - firstDayOfMonth + 1;
                    dateObj = new Date(year, month, dayNum);
                    if (dateObj.toISOString().split('T')[0] === todayStr) {
                        cell.classList.add('today');
                    }
                } else {
                    // Next month
                    dayNum = i - firstDayOfMonth - daysInMonth + 1;
                    dateObj = new Date(year, month + 1, dayNum);
                    cell.classList.add('other-month');
                }
                
                dateStr = dateObj.toISOString().split('T')[0];
                cell.dataset.date = dateStr;

                // Add day number
                cell.innerHTML = `<span class="day-number text-sm">${dayNum}</span>`;
                
                // Find and render events for this day
                const dayEvents = getEventsForDay(dateStr);
                const eventList = document.createElement('div');
                eventList.className = 'mt-1 space-y-1 overflow-y-auto max-h-[80px]';

                dayEvents.forEach(event => {
                    const eventPill = document.createElement('div');
                    eventPill.className = 'event-pill text-xs font-medium px-2 py-0.5 rounded-md cursor-pointer truncate flex items-center';
                    
                    // NEW: Add status icons
                    let statusIcon = '';
                    if (event.paymentStatus === 'Paid') {
                        statusIcon = `<i data-lucide="dollar-sign" class="status-icon text-green-500"></i>`;
                    } else if (event.status === 'Completed') {
                        statusIcon = `<i data-lucide="check-circle" class="status-icon text-green-500"></i>`;
                    } else if (event.status === 'Cancelled') {
                        statusIcon = `<i data-lucide="x-circle" class="status-icon text-red-400"></i>`;
                    }
                    
                    eventPill.innerHTML = `${statusIcon}<span>${event.clientName || event.title}</span>`;
                    
                    const colors = getEventTypeColors(event.type, event.status);
                    eventPill.classList.add(colors.bg, colors.text);
                    
                    eventPill.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent day click
                        openEventModal(event);
                    });
                    eventList.appendChild(eventPill);
                });
                
                cell.appendChild(eventList);

                // Add click listener to day cell (for adding new event)
                cell.addEventListener('click', () => {
                    openEventModal(null, dateObj);
                });

                grid.appendChild(cell);
            }
            
            // Re-render icons for any new elements
            lucide.createIcons();
        }
        
        /**
         * Gets sorted, filtered events for a specific date string (YYYY-MM-DD).
         */
        function getEventsForDay(dateStr) {
            return events
                .filter(event => event.date === dateStr)
                .filter(event => {
                    if (!searchFilter) return true;
                    const title = (event.title || '').toLowerCase();
                    const client = (event.clientName || '').toLowerCase();
                    return title.includes(searchFilter) || client.includes(searchFilter);
                })
                .sort((a, b) => a.time.localeCompare(b.time)); // Sort by time
        }

        /**
         * Changes the current month and re-renders the calendar.
         */
        function changeMonth(offset) {
            currentDate.setMonth(currentDate.getMonth() + offset);
            renderCalendar();
        }

        /**
         * Returns Tailwind color classes for an event type. (Dark theme)
         */
        function getEventTypeColors(type, status = 'Scheduled') {
            // If cancelled, always return grey
            if (status === 'Cancelled') {
                return { bg: 'bg-gray-700', text: 'text-gray-400 line-through' };
            }
            // If completed, return a slightly faded version
            if (status === 'Completed') {
                 switch (type) {
                    case 'Installation':
                        return { bg: 'bg-blue-900', text: 'text-blue-200' };
                    case 'Maintenance':
                        return { bg: 'bg-green-900', text: 'text-green-200' };
                    case 'Filter Change':
                        return { bg: 'bg-yellow-900', text: 'text-yellow-200' };
                    case 'General':
                        return { bg: 'bg-purple-900', text: 'text-purple-200' };
                    default:
                        return { bg: 'bg-gray-800', text: 'text-gray-300' };
                }
            }
            
            // Default active colors
            switch (type) {
                case 'Installation':
                    return { bg: 'bg-blue-600', text: 'text-white' };
                case 'Maintenance':
                    return { bg: 'bg-green-600', text: 'text-white' };
                case 'Filter Change':
                    return { bg: 'bg-yellow-500', text: 'text-gray-900' }; // Keep text dark for yellow
                case 'General':
                    return { bg: 'bg-purple-600', text: 'text-white' };
                default:
                    return { bg: 'bg-gray-600', text: 'text-white' };
            }
        }
        
        // --- Modal Logic ---

        /**
         * Opens a modal.
         */
        function openModal(modal) {
            modal.classList.add('visible');
        }

        /**
         * Closes a modal.
         */
        function closeModal(modal) {
            modal.classList.remove('visible');
        }
        
        /**
         * Opens the Event Modal to add or edit an event.
         * @param {object|null} event - The event object to edit, or null for new.
         * @param {Date|null} date - The date to pre-fill for a new event.
         */
        function openEventModal(event = null, date = null) {
            const modal = document.getElementById('event-modal');
            const form = document.getElementById('event-form');
            form.reset();
            
            selectedEventId = null; // Reset
            
            if (event) {
                // Edit existing event
                document.getElementById('event-modal-title').textContent = 'Edit Appointment';
                document.getElementById('event-id').value = event.id;
                document.getElementById('event-type').value = event.type;
                document.getElementById('event-client-id').value = event.clientId || "";
                document.getElementById('event-title').value = event.title || "";
                document.getElementById('event-date').value = event.date;
                document.getElementById('event-time').value = event.time;
                document.getElementById('event-technician').value = event.technician || "";
                document.getElementById('event-cost').value = event.cost || "";
                document.getElementById('event-notes').value = event.notes || "";
                
                // NEW: Set status fields
                document.getElementById('event-status').value = event.status || "Scheduled";
                document.getElementById('event-payment-status').value = event.paymentStatus || "Not Invoiced";
                document.getElementById('event-filter-used').value = event.filterUsed || "";
                
                // Store old values for inventory logic
                document.getElementById('event-old-status').value = event.status || "Scheduled";
                document.getElementById('event-old-filter-used').value = event.filterUsed || "";
                
                selectedEventId = event.id;
                document.getElementById('btn-delete-event').style.display = 'block';
                
            } else {
                // New event
                document.getElementById('event-modal-title').textContent = 'New Appointment';
                document.getElementById('event-id').value = '';
                if (date) {
                    document.getElementById('event-date').value = date.toISOString().split('T')[0];
                }
                // Set defaults for new event
                document.getElementById('event-status').value = "Scheduled";
                document.getElementById('event-payment-status').value = "Not Invoiced";
                document.getElementById('event-old-status').value = "Scheduled";
                
                document.getElementById('btn-delete-event').style.display = 'none';
            }
            
            toggleEventFormFields(); // Show/hide fields based on type
            openModal(modal);
        }
        
        /**
         * Adjusts the event form fields based on the selected event type.
         */
        function toggleEventFormFields() {
            const eventType = document.getElementById('event-type').value;
            const eventStatus = document.getElementById('event-status').value;
            
            const clientSection = document.getElementById('client-section');
            const titleSection = document.getElementById('title-section');
            const smartReminderSection = document.getElementById('smart-reminder-section');
            const filterUsedSection = document.getElementById('filter-used-section');
            const billingSection = document.getElementById('billing-section');

            if (eventType === 'General') {
                clientSection.style.display = 'none';
                titleSection.style.display = 'block';
                smartReminderSection.style.display = 'none';
                filterUsedSection.style.display = 'none';
            } else {
                clientSection.style.display = 'block';
                titleSection.style.display = 'none';
                
                // Show filter used dropdown for install/change
                if (eventType === 'Installation' || eventType === 'Filter Change') {
                    filterUsedSection.style.display = 'block';
                } else {
                    filterUsedSection.style.display = 'none';
                }
                
                // Show smart reminder only for new installations
                const isNewEvent = !document.getElementById('event-id').value;
                if (eventType === 'Installation' && isNewEvent) {
                    smartReminderSection.style.display = 'block';
                    // Pre-fill lifespan from client if one is selected
                    const clientId = document.getElementById('event-client-id').value;
                    const client = clients.find(c => c.id === clientId);
                    if (client) {
                        document.getElementById('filter-lifespan').value = client.filterLifespanDays || 180;
                    }
                } else {
                    smartReminderSection.style.display = 'none';
                }
            }
            
            // Show billing section only if status is Completed
            if (eventStatus === 'Completed') {
                billingSection.style.display = 'block';
            } else {
                billingSection.style.display = 'none';
                // Reset payment status if job is not complete
                document.getElementById('event-payment-status').value = 'Not Invoiced';
            }
        }
        
        /**
         * Opens the Client Modal to add or edit a client.
         * @param {object|null} client - The client object to edit, or null for new.
         * @param {boolean} fromEventModal - Flag if opened from event modal.
         */
        function openClientModal(client = null, fromEventModal = false) {
            const modal = document.getElementById('client-modal');
            const form = document.getElementById('client-form');
            form.reset();
            
            const historySection = document.getElementById('client-history-section');
            const historyList = document.getElementById('client-history-list');
            historyList.innerHTML = '<p class="text-sm text-gray-400">No history found for this client.</p>';
            
            selectedClientId = null;
            
            // Make sure filter dropdown is populated
            populateInventoryDropdowns();
            
            if (client) {
                // Edit existing client
                document.getElementById('client-modal-title').textContent = 'Edit Client';
                document.getElementById('client-id').value = client.id;
                document.getElementById('client-name').value = client.name;
                document.getElementById('client-phone').value = client.phone || "";
                document.getElementById('client-address').value = client.address || "";
                document.getElementById('client-filter-type').value = client.defaultFilterType || ""; // Now a select
                document.getElementById('client-filter-lifespan').value = client.filterLifespanDays || 180;
                document.getElementById('client-notes').value = client.notes || "";
                
                selectedClientId = client.id;
                document.getElementById('btn-delete-client').style.display = 'block';
                historySection.style.display = 'block';
                
                // Load client history
                renderClientHistory(client.id);
                
            } else {
                // New client
                document.getElementById('client-modal-title').textContent = 'New Client';
                document.getElementById('client-id').value = '';
                document.getElementById('client-filter-lifespan').value = 180; // Default
                document.getElementById('btn-delete-client').style.display = 'none';
                historySection.style.display = 'none';
            }
            
            // Store flag to know if we should re-open event modal
            modal.dataset.fromEventModal = fromEventModal ? 'true' : 'false';
            
            openModal(modal);
        }
        
        /**
         * Fetches and renders the maintenance history for a client from the global `events` array.
         */
        function renderClientHistory(clientId) {
            const historyList = document.getElementById('client-history-list');
            historyList.innerHTML = '<p class="text-sm text-gray-400">Loading history...</p>';
            
            const historyEvents = events
                .filter(event => event.clientId === clientId)
                .sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort descending
            
            if (historyEvents.length === 0) {
                historyList.innerHTML = '<p class="text-sm text-gray-400">No history found for this client.</p>';
                return;
            }
                
            historyList.innerHTML = ''; // Clear
            
            historyEvents.forEach(event => {
                const colors = getEventTypeColors(event.type, event.status);
                
                let statusText = event.status || 'Scheduled';
                if (event.paymentStatus === 'Paid') {
                    statusText = 'Paid';
                } else if (event.paymentStatus === 'Invoiced') {
                    statusText = 'Invoiced';
                }
                
                const item = document.createElement('div');
                // Dark theme history item
                item.className = 'p-3 bg-gray-900/50 border border-gray-700 rounded-lg';
                item.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-semibold text-white">${event.date} @ ${event.time}</span>
                        <span class="text-xs font-medium px-2 py-0.5 rounded-md ${colors.bg} ${colors.text}">${event.type}</span>
                    </div>
                    <p class="text-sm text-gray-300 mt-1">${event.notes || 'No notes.'}</p>
                    <p class="text-xs text-gray-400 mt-1">Status: ${statusText}</p>
                `;
                historyList.appendChild(item);
            });
        }
        
        /**
         * Opens the modal showing upcoming events/reminders.
         */
        function populateRemindersModal() {
            const list = document.getElementById('reminders-list');
            list.innerHTML = '';
            
            const todayStr = new Date().toISOString().split('T')[0];
            
            const upcomingEvents = events
                .filter(event => event.date >= todayStr && event.status !== 'Cancelled') // Hide cancelled
                .sort((a, b) => a.date.localeCompare(b.date) || a.time.localeCompare(b.time));
                
            if (upcomingEvents.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray-400">No upcoming events found.</p>';
                return;
            }
            
            upcomingEvents.forEach(event => {
                const colors = getEventTypeColors(event.type, event.status);
                const item = document.createElement('div');
                // Dark theme reminder item
                item.className = 'p-3 bg-gray-900/50 border border-gray-700 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors';
                item.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-semibold text-white">${event.date} @ ${event.time}</span>
                        <span class="text-xs font-medium px-2 py-0.5 rounded-md ${colors.bg} ${colors.text}">${event.type}</span>
                    </div>
                    <p class="text-sm text-gray-300 mt-1 font-medium">${event.clientName || event.title}</p>
                    <p class="text-sm text-gray-400 mt-1 truncate">${event.notes || 'No notes.'}</p>
                `;
                
                // Add click to open and edit the event
                item.addEventListener('click', () => {
                    closeModal(document.getElementById('reminders-modal'));
                    openEventModal(event);
                });
                
                list.appendChild(item);
            });
        }
        
        function openRemindersModal() {
            populateRemindersModal();
            openModal(document.getElementById('reminders-modal'));
        }
        
        // --- Inventory Modal Logic ---
        function openInventoryModal() {
            renderInventoryList();
            openModal(document.getElementById('inventory-modal'));
        }
        
        /**
         * Renders the list of filter types in the inventory modal.
         */
        function renderInventoryList() {
            const list = document.getElementById('inventory-list');
            if (!list) return;
            list.innerHTML = ''; // Clear
            
            if (inventory.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray-400">No inventory items found. Add one above.</p>';
                return;
            }
            
            inventory.forEach(item => {
                const el = document.createElement('div');
                // Dark theme inventory item
                el.className = 'flex items-center justify-between p-3 bg-gray-900/50 border border-gray-700 rounded-lg';
                el.innerHTML = `
                    <div>
                        <span class="font-semibold text-white">${item.name}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-lg font-bold text-white w-12 text-center">${item.quantity}</span>
                        <button type="button" class="btn-update-stock p-2 bg-gray-700 hover:bg-gray-600 rounded-lg" data-id="${item.id}" data-amount="-1">
                            <i data-lucide="minus" class="w-4 h-4"></i>
                        </button>
                        <button type="button" class="btn-update-stock p-2 bg-gray-700 hover:bg-gray-600 rounded-lg" data-id="${item.id}" data-amount="1">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                list.appendChild(el);
            });
            
            // Add listeners to new buttons
            list.querySelectorAll('.btn-update-stock').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    const amount = parseInt(e.currentTarget.dataset.amount);
                    updateInventoryQuantity(id, amount);
                });
            });
            
            lucide.createIcons();
        }
        
        // --- Client List Modal Logic ---
        function openClientListModal() {
            renderClientList(); // Render the list with current clients
            openModal(document.getElementById('client-list-modal'));
            // Ensure icons are rendered
            lucide.createIcons();
        }

        /**
         * Renders the filterable list of all clients.
         */
        function renderClientList() {
            const list = document.getElementById('client-list-container');
            const searchInput = document.getElementById('client-list-search');
            const filter = searchInput ? searchInput.value.toLowerCase() : '';
            
            if (!list) return;
            list.innerHTML = ''; // Clear
            
            const filteredClients = clients.filter(client => {
                if (!filter) return true;
                const name = (client.name || '').toLowerCase();
                const phone = (client.phone || '').toLowerCase();
                const address = (client.address || '').toLowerCase();
                return name.includes(filter) || phone.includes(filter) || address.includes(filter);
            });

            if (filteredClients.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray-400">No clients found.</p>';
                return;
            }
            
            filteredClients.forEach(client => {
                const el = document.createElement('div');
                // Dark theme client list item
                el.className = 'p-4 bg-gray-900/50 border border-gray-700 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors';
                el.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="font-semibold text-white">${client.name}</span>
                        <span class="text-sm text-gray-400">${client.phone || 'No phone'}</span>
                    </div>
                    <p class="text-sm text-gray-400 mt-1 truncate">${client.address || 'No address'}</p>
                `;
                
                // Add click listener to open the edit modal
                el.addEventListener('click', () => {
                    closeModal(document.getElementById('client-list-modal'));
                    openClientModal(client); // Open client modal for *editing*
                });
                
                list.appendChild(el);
            });
        }

        /**
         * Handles the form to add a new filter type to inventory.
         */
        function handleNewFilterForm(e) {
            e.preventDefault();
            const form = e.target;
            const name = form['new-filter-name'].value;
            const quantity = parseInt(form['new-filter-quantity'].value);
            
            if (!name || isNaN(quantity)) {
                console.warn("Invalid new filter form submission");
                return;
            }
            
            const existing = inventory.find(item => item.name.toLowerCase() === name.toLowerCase());
            if (existing) {
                console.warn("Inventory item already exists");
                return;
            }
            
            const newItem = {
                id: crypto.randomUUID(), // Generate ID
                name: name,
                quantity: quantity
            };
            inventory.push(newItem);
            saveInventory(); // Save and re-render
            
            form.reset();
        }
        
        /**
         * Updates the quantity of an inventory item.
         */
        function updateInventoryQuantity(idOrName, amount) {
            let item;
            // Find by ID first
            item = inventory.find(i => i.id === idOrName);
            // If not found, find by name
            if (!item) {
                item = inventory.find(i => i.name === idOrName);
            }
            
            if (!item) {
                console.error("Inventory item not found:", idOrName);
                return;
            }
            
            const newQuantity = item.quantity + amount;
            if (newQuantity < 0) {
                console.warn(`Cannot reduce stock for ${item.name}. Only ${item.quantity} left.`);
                return;
            }

            // Modify the item in the array
            item.quantity = newQuantity; 
            saveInventory(); // Save the entire inventory array
        }

        // --- Form Submission & Data Logic ---

        /**
         * Handles saving (add/edit) an event.
         */
        function handleEventFormSubmit(e) {
            e.preventDefault();
            const modal = document.getElementById('event-modal');
            const form = e.target;
            const id = form['event-id'].value;
            
            const selectedClientId = form['event-client-id'].value;
            const client = clients.find(c => c.id === selectedClientId);
            
            const eventData = {
                // id, createdAt, updatedAt added below
                type: form['event-type'].value,
                clientId: selectedClientId || null,
                clientName: client ? client.name : null,
                title: form['event-title'].value || null,
                date: form['event-date'].value,
                time: form['event-time'].value || "00:00",
                technician: form['event-technician'].value,
                cost: parseFloat(form['event-cost'].value) || 0,
                notes: form['event-notes'].value,
                status: form['event-status'].value,
                paymentStatus: form['event-payment-status'].value,
                filterUsed: form['event-filter-used'].value || null,
            };

            if (!eventData.date) {
                console.warn("Date is required to save event.");
                return;
            }
            
            if (id) {
                // Update existing
                const index = events.findIndex(ev => ev.id === id);
                if (index > -1) {
                    events[index] = {
                        ...events[index], // Preserve old fields like createdAt
                        ...eventData,     // Apply new data
                        id: id,           // Ensure ID is retained
                        updatedAt: new Date().toISOString()
                    };
                }
            } else {
                // Create new
                eventData.id = crypto.randomUUID(); // Add new ID
                eventData.createdAt = new Date().toISOString();
                eventData.updatedAt = new Date().toISOString();
                events.push(eventData);
                
                // Check for Smart Reminder
                if (eventData.type === 'Installation' && form['create-smart-reminder'].checked) {
                    createSmartReminder(eventData, client, form['filter-lifespan'].value);
                }
            }
            
            saveEvents(); // Save the updated events array
            
            // Handle inventory changes
            const oldStatus = form['event-old-status'].value;
            const newStatus = eventData.status;
            const oldFilter = form['event-old-filter-used'].value;
            const newFilter = eventData.filterUsed;
            
            // Case 1: Job marked as "Completed"
            if (newStatus === 'Completed' && oldStatus !== 'Completed') {
                if (newFilter) {
                    updateInventoryQuantity(newFilter, -1);
                    showToast(`Stock for ${newFilter} reduced by 1.`);
                }
            }
            // Case 2: Job "un-completed" (e.g., set back to Scheduled)
            else if (newStatus !== 'Completed' && oldStatus === 'Completed') {
                if (oldFilter) {
                    updateInventoryQuantity(oldFilter, 1); // Restock
                    showToast(`Stock for ${oldFilter} restocked by 1.`);
                }
            }
            // Case 3: Job was already "Completed" but filter was changed
            else if (newStatus === 'Completed' && oldStatus === 'Completed' && newFilter !== oldFilter) {
                // Restock old filter, deduct new filter
                if (oldFilter) updateInventoryQuantity(oldFilter, 1);
                if (newFilter) updateInventoryQuantity(newFilter, -1);
                showToast(`Stock updated.`);
            }
            
            closeModal(modal);
        }
        
        /**
         * Creates a future "Filter Change" event based on an installation.
         * This just pushes to the `events` array; parent function must call `saveEvents()`.
         */
        function createSmartReminder(installEvent, client, lifespanDays) {
            if (!client || !installEvent.date) return;
            
            const installDate = new Date(installEvent.date + 'T' + (installEvent.time || '12:00:00'));
            const lifespan = parseInt(lifespanDays) || 180;
            
            const changeDate = new Date(installDate);
            changeDate.setDate(changeDate.getDate() + lifespan);
            
            const reminderEventData = {
                id: crypto.randomUUID(), // Generate ID
                type: "Filter Change",
                clientId: client.id,
                clientName: client.name,
                title: `Filter Change for ${client.name}`,
                date: changeDate.toISOString().split('T')[0],
                time: installEvent.time || "10:00", // Default to same time
                technician: installEvent.technician,
                cost: 0, // Placeholder cost
                notes: `Automatic reminder scheduled from installation on ${installEvent.date}. Filter lifespan: ${lifespan} days.`,
                status: "Scheduled",
                paymentStatus: "Not Invoiced",
                filterUsed: null,
                createdAt: new Date().toISOString()
            };
            
            events.push(reminderEventData);
            console.log("Smart reminder prepared.");
        }

        /**
         * Handles saving (add/edit) a client.
         */
        function handleClientFormSubmit(e) {
            e.preventDefault();
            const modal = document.getElementById('client-modal');
            const form = e.target;
            const id = form['client-id'].value;
            
            const clientData = {
                // id, createdAt, updatedAt added below
                name: form['client-name'].value,
                phone: form['client-phone'].value,
                address: form['client-address'].value,
                defaultFilterType: form['client-filter-type'].value,
                filterLifespanDays: parseInt(form['client-filter-lifespan'].value) || 180,
                notes: form['client-notes'].value,
            };

            if (!clientData.name) {
                console.warn("Client name is required.");
                return;
            }
            
            let newClientId = id;
            if (id) {
                // Update existing
                const index = clients.findIndex(c => c.id === id);
                if (index > -1) {
                    clients[index] = {
                        ...clients[index], // Preserve createdAt
                        ...clientData,     // Apply new data
                        id: id,
                        updatedAt: new Date().toISOString()
                    };
                }
            } else {
                // Create new
                newClientId = crypto.randomUUID(); // Get new ID
                clientData.id = newClientId;
                clientData.createdAt = new Date().toISOString();
                clientData.updatedAt = new Date().toISOString();
                clients.push(clientData);
            }
            
            saveClients(); // Save and re-render clients
            
            if (!id && modal.dataset.fromEventModal === 'true') {
                // If we created a new client from event modal
                setTimeout(() => {
                    document.getElementById('event-client-id').value = newClientId; // Use the new ID
                    toggleEventFormFields();
                }, 100);
            }
            
            closeModal(modal);
            
            if (modal.dataset.fromEventModal === 'true') {
                openModal(document.getElementById('event-modal'));
            }
        }
        
        /**
         * Deletes the currently selected event.
         */
        async function deleteSelectedEvent() {
            if (!selectedEventId) return;
            
            const eventToDelete = events.find(e => e.id === selectedEventId);
            if (!eventToDelete) return;

            // Find index and remove
            const index = events.findIndex(e => e.id === selectedEventId);
            if (index > -1) {
                events.splice(index, 1); // Remove from array
                saveEvents(); // Save and re-render
            }
            
            // If the deleted event was "Completed", restock inventory
            if (eventToDelete.status === 'Completed' && eventToDelete.filterUsed) {
                await updateInventoryQuantity(eventToDelete.filterUsed, 1);
                showToast(`Event deleted. Stock for ${eventToDelete.filterUsed} restocked.`);
            } else {
                showToast("Event deleted.");
            }
            
            closeModal(document.getElementById('event-modal'));
            selectedEventId = null;
        }
        
        /**
         * Deletes the currently selected client.
         */
        async function deleteSelectedClient() {
            if (!selectedClientId) return;
            
            console.log("Delete button clicked. In a real app, show a custom confirmation modal here.");
            // We are skipping confirm() as it is blocked in this environment.
            
            const index = clients.findIndex(c => c.id === selectedClientId);
            if (index > -1) {
                clients.splice(index, 1); // Remove from array
                saveClients(); // Save and re-render
            }
            
            closeModal(document.getElementById('client-modal'));
            showToast("Client deleted.");
            selectedClientId = null;
        }

        /**
         * Populates all client <select> dropdowns.
         */
        function populateClientDropdowns() {
            const select = document.getElementById('event-client-id');
            if (!select) return;
            const currentVal = select.value; // Preserve selection
            
            select.innerHTML = '<option value="">Select an existing client</option>'; // Clear
            
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.name;
                select.appendChild(option);
            });
            
            select.value = currentVal; // Restore selection
        }
        
        /**
         * Populates all filter <select> dropdowns from inventory.
         */
        function populateInventoryDropdowns() {
            const dropdowns = [
                document.getElementById('event-filter-used'),
                document.getElementById('client-filter-type')
            ];
            
            dropdowns.forEach(select => {
                if (!select) return;
                const currentVal = select.value;
                select.innerHTML = '<option value="">None</option>'; // Clear
                
                inventory.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.name; // Use name as the value
                    option.textContent = `${item.name} (${item.quantity} in stock)`;
                    select.appendChild(option);
                });
                
                select.value = currentVal; // Restore selection
            });
        }
        
        /**
         * Shows a toast notification with an optional Undo action.
         */
        function showToast(message, undoCallback = null) {
            const toast = document.getElementById('toast-notification');
            const msgEl = document.getElementById('toast-message');
            const undoBtn = document.getElementById('toast-undo-btn');
            
            // Clear any existing timer
            if (toastTimer) clearTimeout(toastTimer);
            
            msgEl.textContent = message;
            
            if (undoCallback) {
                undoBtn.style.display = 'block';
                // Remove previous listener to avoid duplicates
                const newUndoBtn = undoBtn.cloneNode(true);
                undoBtn.parentNode.replaceChild(newUndoBtn, undoBtn);
                
                newUndoBtn.addEventListener('click', () => {
                    undoCallback();
                    toast.classList.remove('show');
                    if (toastTimer) clearTimeout(toastTimer);
                });
            } else {
                undoBtn.style.display = 'none';
            }
            
            toast.classList.add('show');
            
            // Auto-hide after 5 seconds
            toastTimer = setTimeout(() => {
                toast.classList.remove('show');
            }, 5000);
        }
        
        /**
         * Toggles the light/dark theme.
         */
        function toggleDarkMode() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
            } else {
                html.classList.add('dark');
            }
            // Icons are toggled via Tailwind's dark: prefix
            lucide.createIcons(); // Re-render icons to ensure toggle button updates
        }
        
        // Final icon render on init
        lucide.createIcons();

    </script>
</body>
</html>
